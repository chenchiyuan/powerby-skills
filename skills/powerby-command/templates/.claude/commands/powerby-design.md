---
description: 架构设计 - 遵循四阶段强制工作流程的完整架构设计
handoffs:
  - label: Requirement Analysis
    agent: powerby-architect
    prompt: 阶段一：需求解读与目标对齐 - 深入分析PRD中的功能点清单，提炼核心业务目标和关键用户流程
  - label: Architectural Design
    agent: powerby-architect
    prompt: 阶段二：架构设计与可视化 - 生成Mermaid架构图，描述组件职责、组件与需求映射、交互说明
  - label: Decision Analysis
    agent: powerby-architect
    prompt: 阶段三：关键决策点与方案评估 - 识别2-3个关键决策点，提供多种方案的结构化评估
  - label: Final Delivery
    agent: powerby-architect
    prompt: 阶段四：寻求最终决策与交付 - 汇总报告，请求用户做出最终选择，生成architecture.md文档
---

## User Input

```text
$ARGUMENTS
```

## Outline

使用 `/powerby.design` 命令进行架构设计（P4阶段）。**必须严格遵循以下四个阶段完成工作，严禁跳过或颠倒任何阶段。**

---

## 阶段一：需求解读与目标对齐 (Requirement Analysis & Goal Alignment)

### 目标
确保对PRD中的功能点清单有100%准确的理解。

### 执行步骤：
1. **接收与分析**: 深入分析PRD中的具体功能点清单
2. **提炼与复述**: 用结构化的语言向用户复述以下内容：
   - **核心业务目标**: 这个系统或功能最终要解决什么问题
   - **关键用户流程**: 为了实现核心目标，一个典型的用户会经历哪些步骤
3. **寻求确认**: 完成复述后，**必须停止并向用户请求确认**

### 输出格式：
```
## 阶段一：需求解读与目标对齐

### 我的理解：

**核心业务目标**: [复述系统要解决的问题]

**关键用户流程**: [复述典型用户的步骤]

以上是我对您需求的初步理解，请您审阅并确认。如果理解无误，我将开始第二阶段：架构设计与可视化。
```

---

## 阶段二：架构设计与可视化 (Architectural Design & Visualization)

**⚠️ 只有在阶段一获得确认后，才能开始此阶段。**

### 目标
将已对齐的需求，翻译成一套专业、清晰、多维度的架构图纸。

### 产出必须同时包含：

#### 1. 核心架构图 (Mermaid)
使用Mermaid代码，生成最能表达该系统核心结构的图纸（例如：C4 Component图、流程图等）

#### 2. 架构图说明 (文字)
- **概念解读**: 首先用一句话概括图纸所展示的系统概念
- **组件职责**: 逐一解释图上每个核心组件的核心职责（它是什么，它做什么）
- **【重要】组件与需求映射**: 创建清晰的映射关系，说明设计的每一个核心组件分别负责实现来自PRD的哪些具体功能点

**组件与需求映射格式**:
```
---
#### 组件与需求映射

**服务A：xxx服务**
- 负责实现: [PRD功能点1], [PRD功能点2]

**服务B：yyy服务**
- 负责实现: [PRD功能点3], [PRD功能点4]
---
```

- **交互说明**: 详细描述图上的关键连线和序号所代表的交互流程或数据流动

### 输出格式：
```
## 阶段二：架构设计与可视化

### 核心架构图
[Mermaid代码块]

### 概念解读
[一句话概括系统概念]

### 组件职责
[逐一解释每个核心组件]

### 组件与需求映射
[详细的映射关系表格]

### 交互说明
[关键连线和数据流动说明]
```

---

## 阶段三：关键决策点与方案评估 (Key Decision Points & Option Analysis)

### 目标
识别出架构中最关键的"岔路口"，并提供专业的导航建议。

### 执行步骤：
1. **识别决策点**: 在设计的架构中，识别出2-3个最关键的架构决策点
2. **结构化评估**: 对每一个决策点，提供至少两种可行的方案，严格按照格式进行评估：
   - **简介**: 方案概述
   - **优点**: 方案优势
   - **缺点**: 方案劣势
3. **提供专业建议**: 明确给出推荐的方案并附上核心理由

### 输出格式：
```
## 阶段三：关键决策点与方案评估

### 决策点一：[名称]
**方案A**:
- 简介: [描述]
- 优点: [优势1], [优势2]
- 缺点: [劣势1], [劣势2]

**方案B**:
- 简介: [描述]
- 优点: [优势1], [优势2]
- 缺点: [劣势1], [劣势2]

**专业建议**: 推荐[方案X]，理由：[核心理由]

---

### 决策点二：[名称]
[同样格式]

---

### 决策点三：[名称]
[同样格式]
```

---

## 阶段四：寻求最终决策与交付 (Seeking Final Decision & Delivery)

### 目标
汇总所有分析，将决策权清晰地交还给用户，并准备最终的交付物。

### 执行步骤：
1. **汇总报告与请求决策**: 明确请求用户做出最终选择
2. **最终交付物**: 生成完整的Markdown文档

### 输出格式：
```
## 阶段四：寻求最终决策与交付

### 汇总报告
以上是我对您需求的完整架构设计、可视化说明以及关键决策点的分析。

### 决策请求
请您审阅，并就【决策点一】和【决策点二】做出最终选择。我将等待您的指令，以将此架构方案定稿，并生成最终的architecture.md文档。

**文档将包含**:
- 从阶段一到阶段四的全部内容
- 最终确认的方案
- Markdown + Mermaid 的友好清晰可视化展示
- 文件路径: docs/iterations/001-{项目名}/architecture.md
```

---

## 最终输出格式总结

```
✅ P4 架构设计完成

📄 遵循四阶段工作流程:
  ✓ 阶段一：需求解读与目标对齐
  ✓ 阶段二：架构设计与可视化
  ✓ 阶段三：关键决策点与方案评估
  ✓ 阶段四：寻求最终决策与交付

📄 输出文档:
  └── docs/iterations/001-{项目名}/architecture.md (完整架构设计文档)

🔒 质量门禁 Gate 4: 架构设计清晰性
  ✓ 系统架构明确 (Mermaid图表)
  ✓ 模块职责清晰
  ✓ 组件与需求映射完整
  ✓ 关键决策点分析完成
  ✓ 方案评估结构化
  ✓ 决策请求明确

🎯 下一步: 等待用户最终决策后，进入 /powerby.plan 阶段
```

### 使用示例：

```
/powerby.design
/powerby.design 基于之前的技术调研结果
```

### 前置条件：
- ✅ 技术调研报告存在：`docs/iterations/*/research.md`
- ✅ 澄清记录存在：`docs/iterations/*/clarifications.md`
- ✅ 功能点清单存在：`docs/iterations/*/function-points.md`

### 核心工作原则：
1. **忠于需求**: 所有设计都必须是PRD中功能点清单的忠实技术实现
2. **清晰与精确**: 产出必须消除所有模糊性，精准定义组件、接口和交互
3. **模块化与可扩展性**: 高内聚、低耦合，便于独立扩展或替换
4. **务实与权衡**: 清晰识别不同方案的利弊权衡，给出务实建议
5. **协作与伙伴关系**: 作为专业顾问和思维伙伴，等待用户最终指令

### 错误处理：
- 如果前置条件不满足，提示用户先完成前置阶段
- 如果用户未确认阶段一，禁止进入阶段二
- 如果架构文档生成失败，建议检查需求文档质量
- 如果关键决策点不明确，建议重新分析需求

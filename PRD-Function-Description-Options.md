# PRD功能点描述优化方案

## 当前问题分析

现有PRD文档在"第二部分：功能规格框架"中的功能点描述存在以下问题：
1. **颗粒度不均**：功能项1-3较宏观，混合了多个原子级功能点
2. **可追踪性不足**：从需求原始输入到功能规格的映射不够清晰
3. **原子化不够**：功能点仍包含多个子功能，难以独立实现和测试
4. **缺乏依赖关系**：未明确功能点之间的前置依赖

---

## 方案A：渐进式细化方案
**特点**：保持现有结构，细化每个功能项为原子级功能点

### 改进内容

#### 功能项 1: 多DEX价格聚合展示

**拆解为3个原子功能点**：

##### F1.1 单DEX价格查询
- **需求来源**: 原始需求"我希望能够在一个页面上看到Uniswap、SushiSwap、PancakeSwap等多个DEX的同一交易对价格"
- **输入**: 交易对标识（如ETH/USDC）
- **输出**: DEX名称、价格、流动性数据
- **前置依赖**: 无
- **验收标准**:
  - [ ] 输入有效的ERC-20交易对，返回对应的链上价格
  - [ ] 价格数据来源可追溯（具体到DEX和交易池）
  - [ ] API响应时间<3秒
  - [ ] 支持至少3个主流DEX

##### F1.2 多DEX并行查询
- **需求来源**: 原始需求"同时查看多个DEX的价格"
- **输入**: 交易对标识 + DEX列表
- **输出**: 多DEX价格聚合结果
- **前置依赖**: F1.1
- **验收标准**:
  - [ ] 同时查询3个DEX，无串行等待
  - [ ] 部分DEX失败时不影响整体结果展示
  - [ ] 聚合结果按价格排序
  - [ ] 总响应时间<5秒

##### F1.3 价格变化趋势展示
- **需求来源**: 原始需求"价格变化趋势指示（涨跌幅）"
- **输入**: 历史价格数据（近24小时）
- **输出**: 价格变化百分比和趋势箭头
- **前置依赖**: F1.2
- **验收标准**:
  - [ ] 显示过去24小时价格变化百分比
  - [ ] 用颜色和箭头清晰指示涨跌
  - [ ] 数据刷新频率与价格同步

#### 功能项 2: 费用计算与展示

**拆解为3个原子功能点**：

##### F2.1 手续费率获取
- **需求来源**: 原始需求"系统自动计算手续费"
- **输入**: DEX标识
- **输出**: 该DEX的标准手续费率
- **前置依赖**: F1.1
- **验收标准**:
  - [ ] 获取Uniswap V3的0.3%费率
  - [ ] 获取SushiSwap的0.3%费率
  - [ ] 获取PancakeSwap的0.25%费率
  - [ ] 费率数据缓存24小时

##### F2.2 滑点预估计算
- **需求来源**: 原始需求"基于交易数量计算预估滑点"
- **输入**: 交易数量、交易对、DEX流动性
- **输出**: 预估滑点百分比
- **前置依赖**: F1.1, F2.1
- **验收标准**:
  - [ ] 基于流动性深度计算滑点
  - [ ] 预估误差<10%
  - [ ] 支持不同交易量级（0.1-100 ETH）
  - [ ] 滑点>0.5%时显示警告

##### F2.3 最终到手金额计算
- **需求来源**: 原始需求"显示最终到手金额"
- **输入**: 输入金额、价格、手续费率、滑点
- **输出**: 扣除所有费用后的实际到手金额
- **前置依赖**: F1.2, F2.1, F2.2
- **验收标准**:
  - [ ] 计算公式：最终金额 = 输入金额 × 价格 × (1 - 手续费率 - 滑点)
  - [ ] 精度保留8位小数
  - [ ] 金额展示包含所有费用明细

#### 功能项 3: 交易跳转

**拆解为2个原子功能点**：

##### F3.1 DEX链接生成
- **需求来源**: 原始需求"一键跳转到对应DEX进行交易"
- **输入**: DEX标识、交易对
- **输出**: 跳转到该DEX交易的URL
- **前置依赖**: F1.2
- **验收标准**:
  - [ ] 生成Uniswap V3的swap URL
  - [ ] 生成SushiSwap的swap URL
  - [ ] 生成PancakeSwap的swap URL
  - [ ] URL包含正确的交易对参数

##### F3.2 跳转执行
- **需求来源**: 原始需求"能够一键跳转"
- **输入**: DEX链接
- **输出**: 在新窗口打开DEX交易页面
- **前置依赖**: F3.1
- **验收标准**:
  - [ ] 点击按钮后在新标签页打开
  - [ ] 不影响当前页面状态
  - [ ] 支持钱包连接参数传递

---

## 方案B：Spec-Kit风格重构方案
**特点**：完全采用Spec-Kit的功能点描述格式，强调可追溯性和原子化

### 改进内容

```markdown
### 功能规格框架

#### 模块1: 价格查询模块 (Price Query Module)

**模块目标**: 提供多DEX价格数据查询能力

**需求追踪矩阵**:

| 需求ID | 原始需求描述 | 功能点ID | 功能点描述 |
|--------|------------|----------|------------|
| RQ-001 | 在一个页面看到多个DEX价格 | F-1.1, F-1.2 | 单DEX查询 + 并行聚合 |
| RQ-002 | 显示手续费和滑点后金额 | F-2.1, F-2.2, F-2.3 | 费率获取 + 滑点计算 + 最终金额 |
| RQ-003 | 一键跳转到DEX交易 | F-3.1, F-3.2 | 链接生成 + 跳转执行 |

**原子功能点清单**:

##### F-1.1: 单DEX价格查询 [P0]
- **功能描述**: 查询指定DEX的指定交易对价格
- **输入规格**:
  - `dexId`: String (必选, 枚举: ["uniswap-v3", "sushiswap", "pancakeswap"])
  - `tokenIn`: String (必选, ERC-20合约地址)
  - `tokenOut`: String (必选, ERC-20合约地址)
  - `amountIn`: BigNumber (可选, 默认1.0)
- **输出规格**:
  - `price`: BigNumber (必选, 价格，精度18位)
  - `liquidity`: BigNumber (必选, 池子流动性)
  - `timestamp`: Number (必选, Unix时间戳)
  - `source`: String (必选, 数据来源DEX)
- **业务规则**:
  - BR-1.1.1: tokenIn和tokenOut不能相同
  - BR-1.1.2: 价格数据时效性≤10秒
- **验收标准**:
  - [TC-1.1.1] 输入ETH/USDC，返回Uniswap V3当前价格
  - [TC-1.1.2] 输入无效DEX，抛出ValidationError
  - [TC-1.1.3] API超时时间=3秒
- **依赖关系**: 无
- **复杂度**: 低 (3人天)

##### F-1.2: 多DEX并行价格聚合 [P0]
- **功能描述**: 并行查询多个DEX价格并聚合结果
- **输入规格**:
  - `tokenPair`: String (必选, 交易对如"ETH/USDC")
  - `dexList`: Array<String> (必选, 要查询的DEX列表)
- **输出规格**:
  - `results`: Array<PriceResult> (必选, 排序后的价格结果)
    - `dexId`: String
    - `price`: BigNumber
    - `effectivePrice`: BigNumber (扣除费用后)
  - `failedDexes`: Array<String> (可选, 查询失败的DEX)
- **业务规则**:
  - BR-1.2.1: 并行查询，无串行等待
  - BR-1.2.2: 按effectivePrice降序排列
  - BR-1.2.3: 部分失败不影响整体
- **验收标准**:
  - [TC-1.2.1] 同时查询3个DEX，总响应<5秒
  - [TC-1.2.2] 结果按价格排序正确
  - [TC-1.2.3] 1个DEX失败时返回另外2个结果
- **依赖关系**: F-1.1
- **复杂度**: 中 (5人天)

##### F-2.1: DEX手续费率获取 [P0]
- **功能描述**: 获取指定DEX的标准交易手续费率
- **输入规格**:
  - `dexId`: String (必选)
- **输出规格**:
  - `feeRate`: Number (必选, 百分比，如0.3表示0.3%)
  - `gasEstimate`: Number (可选, 预估Gas费用)
- **业务规则**:
  - BR-2.1.1: 费率从DEX合约实时获取
  - BR-2.1.2: 缓存24小时
- **验收标准**:
  - [TC-2.1.1] Uniswap V3返回0.3%
  - [TC-2.1.2] SushiSwap返回0.3%
  - [TC-2.1.3] PancakeSwap返回0.25%
- **依赖关系**: F-1.1
- **复杂度**: 低 (2人天)

##### F-2.2: 滑点预估计算 [P1]
- **功能描述**: 基于流动性深度计算交易滑点
- **输入规格**:
  - `amountIn`: BigNumber (必选, 输入数量)
  - `tokenPair`: String (必选, 交易对)
  - `dexId`: String (必选)
- **输出规格**:
  - `slippageRate`: Number (必选, 滑点百分比)
  - `impactLevel`: String (必选, 枚举: ["low", "medium", "high"])
- **业务规则**:
  - BR-2.2.1: 滑点>0.5%标记为high impact
  - BR-2.2.2: 基于流动性深度非线性计算
- **验收标准**:
  - [TC-2.2.1] 1 ETH交易滑点预估误差<10%
  - [TC-2.2.2] 100 ETH交易滑点预估误差<15%
- **依赖关系**: F-1.1
- **复杂度**: 高 (8人天)

##### F-2.3: 最终到手金额计算 [P0]
- **功能描述**: 计算扣除所有费用后的实际到手金额
- **输入规格**:
  - `amountIn`: BigNumber (必选, 输入数量)
  - `price`: BigNumber (必选, 实时价格)
  - `feeRate`: Number (必选, 手续费率)
  - `slippageRate`: Number (必选, 滑点率)
- **输出规格**:
  - `amountOut`: BigNumber (必选, 最终到手金额)
  - `feeBreakdown`: Object (必选, 费用明细)
    - `tradingFee`: BigNumber
    - `slippageLoss`: BigNumber
- **业务规则**:
  - BR-2.3.1: 计算公式 = amountIn × price × (1 - feeRate - slippageRate)
  - BR-2.3.2: 精度保留8位小数
- **验收标准**:
  - [TC-2.3.1] 1 ETH输入计算结果准确
  - [TC-2.3.2] 费用明细展示清晰
- **依赖关系**: F-1.2, F-2.1, F-2.2
- **复杂度**: 低 (2人天)

##### F-3.1: DEX交易链接生成 [P0]
- **功能描述**: 生成跳转到指定DEX进行交易的URL
- **输入规格**:
  - `dexId`: String (必选)
  - `tokenIn`: String (必选, 合约地址)
  - `tokenOut`: String (必选, 合约地址)
- **输出规格**:
  - `url`: String (必选, 完整的swap URL)
  - `walletParam`: String (可选, 钱包地址参数)
- **业务规则**:
  - BR-3.1.1: URL包含正确的swap参数
  - BR-3.1.2: 支持MetaMask等钱包
- **验收标准**:
  - [TC-3.1.1] Uniswap URL可直接打开swap页面
  - [TC-3.1.2] URL包含正确的token地址
- **依赖关系**: F-1.2
- **复杂度**: 低 (2人天)

##### F-3.2: 交易跳转执行 [P0]
- **功能描述**: 在新窗口打开DEX交易页面
- **输入规格**:
  - `url`: String (必选)
- **输出规格**:
  - `success`: Boolean (必选, 是否成功打开)
- **业务规则**:
  - BR-3.2.1: 在新标签页打开，不影响当前页
  - BR-3.2.2: URL安全校验
- **验收标准**:
  - [TC-3.2.1] 点击后新标签页正确打开
  - [TC-3.2.2] 恶意URL被拦截
- **依赖关系**: F-3.1
- **复杂度**: 低 (1人天)
```

---

## 方案C：混合优化方案
**特点**：保持PRD可读性，同时增加功能点的结构化描述

### 改进内容

```markdown
### 功能规格框架

#### 功能模块1: 价格聚合模块

**模块概述**: 从多个DEX获取并聚合价格数据

**用户故事驱动拆解**:

> "作为交易员，我想要同时查看多个DEX的价格" (US-1)

拆解为以下原子功能点：

##### F1.1 单DEX价格查询 [P0]
**需求来源**: US-1
**功能描述**: 从单个DEX获取指定交易对的实时价格
**用户输入**:
- 选择DEX (Uniswap V3 / SushiSwap / PancakeSwap)
- 选择交易对 (ETH/USDC, BTC/ETH等)
**系统输出**:
- 价格数值 (保留8位小数)
- 流动性深度
- 价格更新时间戳
**关键约束**:
- API响应时间<3秒
- 价格数据时效性≤10秒
**验收标准**:
- [ ] 能查询主流ERC-20交易对价格
- [ ] 价格与链上实际成交价格误差<2%
- [ ] 支持3个主流DEX
**依赖关系**: 无
**预估工时**: 3人天

##### F1.2 多DEX并行聚合 [P0]
**需求来源**: US-1
**功能描述**: 并行查询多个DEX价格，自动排序展示
**用户输入**:
- 选择交易对
**系统输出**:
- 按最优价格排序的DEX列表
- 每个DEX的价格和可用性状态
**关键约束**:
- 并行查询，无串行等待
- 部分DEX失败不影响整体展示
**验收标准**:
- [ ] 同时查询3个DEX，总响应<5秒
- [ ] 按effectivePrice降序正确排序
- [ ] 1个DEX失败时显示其他2个结果
**依赖关系**: F1.1
**预估工时**: 5人天

##### F1.3 价格趋势指示 [P1]
**需求来源**: 原始需求"价格变化趋势指示"
**功能描述**: 显示24小时价格变化百分比和趋势箭头
**用户输入**: 无 (自动展示)
**系统输出**:
- 涨跌幅百分比 (如 +2.5% 或 -1.8%)
- 趋势箭头 (↑ 绿色 / ↓ 红色)
**关键约束**:
- 数据刷新频率与价格同步
- 趋势计算基于过去24小时数据
**验收标准**:
- [ ] 涨跌颜色和箭头正确显示
- [ ] 百分比计算准确
**依赖关系**: F1.2
**预估工时**: 3人天

#### 功能模块2: 费用计算模块

**模块概述**: 计算交易相关的所有费用和最终到手金额

> "作为用户，我想要看到扣除手续费和滑点后的实际到手金额" (US-2)

##### F2.1 手续费率获取 [P0]
**需求来源**: US-2
**功能描述**: 获取各DEX的标准交易手续费率
**用户输入**: 无 (自动获取)
**系统输出**:
- 各DEX的手续费率 (Uniswap 0.3%, SushiSwap 0.3%, PancakeSwap 0.25%)
**关键约束**:
- 从合约实时获取最新费率
- 费率数据缓存24小时
**验收标准**:
- [ ] 费率数据准确匹配各DEX标准
- [ ] 缓存机制正常工作
**依赖关系**: F1.1
**预估工时**: 2人天

##### F2.2 滑点预估 [P1]
**需求来源**: US-2
**功能描述**: 基于交易数量和流动性计算预估滑点
**用户输入**: 交易数量 (用户输入或默认)
**系统输出**:
- 滑点百分比 (如 0.15%)
- 影响级别 (低/中/高)
**关键约束**:
- 预估误差控制在10%以内
- 滑点>0.5%时显示警告
**验收标准**:
- [ ] 不同交易量级预估准确
- [ ] 警告机制正确触发
**依赖关系**: F1.1
**预估工时**: 8人天

##### F2.3 最终金额计算 [P0]
**需求来源**: US-2
**功能描述**: 计算扣除所有费用后的实际到手金额
**用户输入**: 交易数量
**系统输出**:
- 最终到手金额
- 费用明细分解 (手续费 + 滑点损失)
**关键约束**:
- 计算公式透明可见
- 精度保留8位小数
**验收标准**:
- [ ] 计算公式: 最终金额 = 输入金额 × 价格 × (1 - 手续费率 - 滑点率)
- [ ] 费用明细清晰展示
**依赖关系**: F1.2, F2.1, F2.2
**预估工时**: 2人天

#### 功能模块3: 交易执行模块

**模块概述**: 提供跳转到DEX进行实际交易的能力

> "作为用户，我想要一键跳转到最优价格的DEX进行交易" (US-3)

##### F3.1 交易链接生成 [P0]
**需求来源**: US-3
**功能描述**: 生成跳转到指定DEX进行swap的URL
**用户输入**: 选择的目标DEX
**系统输出**:
- 完整的swap URL
- 预填充的交易参数
**关键约束**:
- URL格式符合各DEX标准
- 支持钱包地址传递
**验收标准**:
- [ ] URL能直接打开对应DEX swap页面
- [ ] 交易参数正确传递
**依赖关系**: F1.2
**预估工时**: 2人天

##### F3.2 跳转执行 [P0]
**需求来源**: US-3
**功能描述**: 在新窗口/标签页打开DEX交易页面
**用户输入**: 点击"前往交易"按钮
**系统输出**:
- 新标签页打开交易页面
**关键约束**:
- 不影响当前页面状态
- URL安全校验
**验收标准**:
- [ ] 新标签页正确打开
- [ ] 恶意URL被拦截
**依赖关系**: F3.1
**预估工时**: 1人天

### 功能点优先级汇总

| 模块 | P0功能 | P1功能 | P2功能 | 总计 |
|------|-------|-------|-------|------|
| 价格聚合 | 2 | 1 | 0 | 3 |
| 费用计算 | 2 | 1 | 0 | 3 |
| 交易执行 | 2 | 0 | 0 | 2 |
| **合计** | **6** | **2** | **0** | **8** |

### 功能依赖关系图

```
F1.1 (单DEX查询)
  ↓
F1.2 (多DEX聚合) ─┬─ F2.1 (费率获取)
  ↓               │
F2.3 (最终金额) ─┘
  ↓
F3.1 (链接生成)
  ↓
F3.2 (跳转执行)
```
```

---

## 三方案对比

| 维度 | 方案A: 渐进式细化 | 方案B: Spec-Kit风格 | 方案C: 混合优化 |
|------|------------------|--------------------|----------------|
| **可读性** | ⭐⭐⭐⭐ 高 | ⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 最高 |
| **结构化程度** | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐⭐ 高 |
| **实现指导性** | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐⭐ 高 |
| **需求追踪性** | ⭐⭐ 中等 | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐⭐ 高 |
| **维护成本** | ⭐⭐ 低 | ⭐⭐⭐⭐⭐ 高 | ⭐⭐⭐ 中等 |
| **团队学习曲线** | ⭐⭐⭐ 平缓 | ⭐⭐ 陡峭 | ⭐⭐⭐⭐ 平缓 |
| **适用场景** | 快速迭代 | 严格合规 | 平衡需求 |

## 最终决策

### ✅ 已选择方案C (混合优化方案)

**决策日期**: 2025-12-17
**决策人**: PowerBy产品团队
**状态**: 已实施

**选择理由**：

1. ✅ **保持PRD可读性**：产品经理和业务方容易理解
2. ✅ **增强实现指导性**：开发团队能明确知道要做什么
3. ✅ **需求可追溯**：从用户故事到功能点的追踪链清晰
4. ✅ **团队易接受**：不需要学习新的复杂格式
5. ✅ **迭代友好**：便于后续P1/P2功能逐步添加

**实施状态**：

- ✅ 已更新 `templates/prd-template.md` - 应用方案C的8要素结构
- ✅ 已创建 `docs/Function-Description-Best-Practices.md` - 详细使用指南
- ✅ 已更新 `demo-prd.md` - 方案C格式的完整示例
- ✅ 已更新所有技能文档 - v2.0.0版本支持新的功能点格式
- ✅ 已更新 `CHANGELOG.md` - 记录v2.0.0所有变更

**8要素功能点结构** (方案C)：

```
FX.X [功能点名称] [优先级]
✓ 需求来源: US-X
✓ 功能描述: [1-2句话]
✓ 用户输入: [格式化的输入参数]
✓ 系统输出: [格式化的输出结果]
✓ 关键约束: [性能和业务约束]
✓ 验收标准: [SMART原则的可测试标准]
✓ 依赖关系: [功能点依赖图]
✓ 预估工时: [开发成本估算]
```

**核心优势**：
- 从13个宏观功能 → 8个原子功能点
- 可追踪性从低提升到高
- 可执行性从中等提升到高
- 新增清晰的依赖关系可视化
- 新增每个功能点的预估工时

---
**版本**: v2.0.0
**维护者**: PowerBy产品团队
